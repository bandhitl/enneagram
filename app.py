import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np

# ---------- CONFIG ---------- #
st.set_page_config(page_title="Enneagram Deep Test", layout="wide")
st.title("ðŸ§  Enneagram 81-Question Test (Core / Shadow / Behavior)")

# ---------- INITIAL DATA ---------- #
@st.cache_data
def load_questions():
    df = pd.read_csv("questions.csv")
    return df.sample(frac=1, random_state=42).reset_index(drop=True)

df_questions = load_questions()

# ---------- UNIVERSAL SUB-QUESTIONS ---------- #
universal_sub_questions = [
    {'question': 'à¸„à¸¸à¸“à¸„à¸´à¸”à¸§à¹ˆà¸²à¸•à¸±à¸§à¹€à¸­à¸‡à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹‚à¸”à¸¢à¸­à¸´à¸‡à¸ˆà¸²à¸à¸­à¸°à¹„à¸£à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸?', 'choices': [
        'à¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ / à¸ˆà¸£à¸´à¸¢à¸˜à¸£à¸£à¸¡ (Type 1)', 'à¸à¸²à¸£à¹„à¸”à¹‰à¸£à¸±à¸šà¸à¸²à¸£à¸£à¸±à¸à¸«à¸£à¸·à¸­à¸¢à¸­à¸¡à¸£à¸±à¸š (Type 2)',
        'à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢ / à¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ (Type 3)', 'à¸­à¸²à¸£à¸¡à¸“à¹Œà¸ à¸²à¸¢à¹ƒà¸™à¹à¸¥à¸°à¹€à¸­à¸à¸¥à¸±à¸à¸©à¸“à¹Œ (Type 4)',
        'à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰ à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸¥à¸¶à¸ (Type 5)', 'à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¹à¸¥à¸°à¸à¸²à¸£à¸§à¸²à¸‡à¹à¸œà¸™ (Type 6)',
        'à¸­à¸´à¸ªà¸£à¸°à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¸ªà¸™à¸¸à¸ (Type 7)', 'à¸žà¸¥à¸±à¸‡à¸­à¸³à¸™à¸²à¸ˆà¹à¸¥à¸°à¸à¸²à¸£à¸„à¸§à¸šà¸„à¸¸à¸¡ (Type 8)',
        'à¸„à¸§à¸²à¸¡à¸ªà¸‡à¸šà¹à¸¥à¸°à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸„à¸§à¸²à¸¡à¸‚à¸±à¸”à¹à¸¢à¹‰à¸‡ (Type 9)'
    ]},
    {'question': 'à¸„à¸¸à¸“à¸à¸¥à¸±à¸§à¸ªà¸´à¹ˆà¸‡à¹ƒà¸”à¸¡à¸²à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹ƒà¸™à¸Šà¸µà¸§à¸´à¸•?', 'choices': [
        'à¸à¸²à¸£à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¸—à¸²à¸‡à¸¨à¸µà¸¥à¸˜à¸£à¸£à¸¡ (Type 1)', 'à¸à¸²à¸£à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸„à¸£à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ (Type 2)',
        'à¸„à¸§à¸²à¸¡à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§à¹à¸¥à¸°à¹„à¸¡à¹ˆà¸™à¹ˆà¸²à¸›à¸£à¸°à¸—à¸±à¸šà¹ƒà¸ˆ (Type 3)', 'à¸à¸²à¸£à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸„à¸£à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆ (Type 4)',
        'à¸à¸²à¸£à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸£à¸·à¸­à¸–à¸¹à¸à¸„à¸§à¸šà¸„à¸¸à¸¡ (Type 5)', 'à¸à¸²à¸£à¹„à¸¡à¹ˆà¸¡à¸µà¸«à¸¥à¸±à¸à¸¢à¸¶à¸” / à¹‚à¸”à¸”à¹€à¸”à¸µà¹ˆà¸¢à¸§ (Type 6)',
        'à¸„à¸§à¸²à¸¡à¹€à¸šà¸·à¹ˆà¸­ / à¸„à¸§à¸²à¸¡à¹€à¸ˆà¹‡à¸šà¸›à¸§à¸” (Type 7)', 'à¸à¸²à¸£à¹„à¸£à¹‰à¸žà¸¥à¸±à¸‡ / à¸–à¸¹à¸à¸„à¸£à¸­à¸šà¸‡à¸³ (Type 8)',
        'à¸„à¸§à¸²à¸¡à¸‚à¸±à¸”à¹à¸¢à¹‰à¸‡ / à¸„à¸§à¸²à¸¡à¸§à¸¸à¹ˆà¸™à¸§à¸²à¸¢ (Type 9)'
    ]}
]

# ---------- MAPPING FOR SUB-ANALYSIS ---------- #
sub_analysis_map = {
    # Q1
    'à¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ / à¸ˆà¸£à¸´à¸¢à¸˜à¸£à¸£à¸¡ (Type 1)': 'à¸„à¸¸à¸“à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹‚à¸”à¸¢à¸„à¸³à¸™à¸¶à¸‡à¸–à¸¶à¸‡à¸«à¸¥à¸±à¸à¸ˆà¸£à¸´à¸¢à¸˜à¸£à¸£à¸¡à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸',
    'à¸à¸²à¸£à¹„à¸”à¹‰à¸£à¸±à¸šà¸à¸²à¸£à¸£à¸±à¸à¸«à¸£à¸·à¸­à¸¢à¸­à¸¡à¸£à¸±à¸š (Type 2)': 'à¸„à¸¸à¸“à¸¡à¸±à¸à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹‚à¸”à¸¢à¸„à¸³à¸™à¸¶à¸‡à¸–à¸¶à¸‡à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸žà¸±à¸™à¸˜à¹Œà¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸­à¸·à¹ˆà¸™',
    'à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢ / à¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ (Type 3)': 'à¸„à¸¸à¸“à¹€à¸¥à¸·à¸­à¸à¸—à¸²à¸‡à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¹€à¸ªà¸£à¸´à¸¡à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢à¹à¸¥à¸°à¸ à¸²à¸žà¸¥à¸±à¸à¸©à¸“à¹Œà¹à¸«à¹ˆà¸‡à¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ',
    'à¸­à¸²à¸£à¸¡à¸“à¹Œà¸ à¸²à¸¢à¹ƒà¸™à¹à¸¥à¸°à¹€à¸­à¸à¸¥à¸±à¸à¸©à¸“à¹Œ (Type 4)': 'à¸„à¸¸à¸“à¹ƒà¸«à¹‰à¸„à¸§à¸²à¸¡à¸ªà¸³à¸„à¸±à¸à¸à¸±à¸šà¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸ à¸²à¸¢à¹ƒà¸™à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¸‚à¸­à¸‡à¸•à¸±à¸§à¹€à¸­à¸‡',
    'à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰ à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸¥à¸¶à¸ (Type 5)': 'à¸„à¸¸à¸“à¹€à¸™à¹‰à¸™à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹€à¸Šà¸´à¸‡à¸¥à¸¶à¸à¸à¹ˆà¸­à¸™à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ',
    'à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¹à¸¥à¸°à¸à¸²à¸£à¸§à¸²à¸‡à¹à¸œà¸™ (Type 6)': 'à¸„à¸¸à¸“à¸§à¸²à¸‡à¹à¸œà¸™à¹à¸¥à¸°à¹€à¸•à¸£à¸µà¸¢à¸¡à¸žà¸£à¹‰à¸­à¸¡à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸§à¸²à¸¡à¸¡à¸±à¹ˆà¸™à¸„à¸‡',
    'à¸­à¸´à¸ªà¸£à¸°à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¸ªà¸™à¸¸à¸ (Type 7)': 'à¸„à¸¸à¸“à¸¡à¸­à¸‡à¸«à¸²à¸„à¸§à¸²à¸¡à¸ªà¸™à¸¸à¸à¹à¸¥à¸°à¸­à¸´à¸ªà¸£à¸°à¹€à¸›à¹‡à¸™à¸«à¸¥à¸±à¸à¹ƒà¸™à¸à¸²à¸£à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ',
    'à¸žà¸¥à¸±à¸‡à¸­à¸³à¸™à¸²à¸ˆà¹à¸¥à¸°à¸à¸²à¸£à¸„à¸§à¸šà¸„à¸¸à¸¡ (Type 8)': 'à¸„à¸¸à¸“à¹€à¸¥à¸·à¸­à¸à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸—à¸µà¹ˆà¹ƒà¸«à¹‰à¸„à¸¸à¸“à¸„à¸§à¸šà¸„à¸¸à¸¡à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œà¹à¸¥à¸°à¹€à¸‚à¹‰à¸¡à¹à¸‚à¹‡à¸‡',
    'à¸„à¸§à¸²à¸¡à¸ªà¸‡à¸šà¹à¸¥à¸°à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸„à¸§à¸²à¸¡à¸‚à¸±à¸”à¹à¸¢à¹‰à¸‡ (Type 9)': 'à¸„à¸¸à¸“à¹€à¸¥à¸·à¸­à¸à¸„à¸§à¸²à¸¡à¸ªà¸‡à¸šà¹à¸¥à¸°à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸„à¸§à¸²à¸¡à¸‚à¸±à¸”à¹à¸¢à¹‰à¸‡à¹€à¸›à¹‡à¸™à¸ªà¸³à¸„à¸±à¸',
    # Q2
    'à¸à¸²à¸£à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¸—à¸²à¸‡à¸¨à¸µà¸¥à¸˜à¸£à¸£à¸¡ (Type 1)': 'à¸„à¸¸à¸“à¸à¸¥à¸±à¸§à¸—à¸³à¸œà¸´à¸”à¸ˆà¸£à¸´à¸¢à¸˜à¸£à¸£à¸¡ à¸ˆà¸¶à¸‡à¸£à¸°à¸¡à¸±à¸”à¸£à¸°à¸§à¸±à¸‡à¹„à¸¡à¹ˆà¹ƒà¸«à¹‰à¸¥à¹ˆà¸§à¸‡à¹€à¸à¸´à¸™à¸¡à¸²à¸•à¸£à¸à¸²à¸™',
    'à¸à¸²à¸£à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸„à¸£à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ (Type 2)': 'à¸„à¸¸à¸“à¸à¸¥à¸±à¸§à¹„à¸£à¹‰à¸„à¸¸à¸“à¸„à¹ˆà¸² à¸ˆà¸¶à¸‡à¸”à¸¹à¹à¸¥à¸„à¸§à¸²à¸¡à¸ªà¸±à¸¡à¸žà¸±à¸™à¸˜à¹Œà¹„à¸§à¹‰à¹€à¸ªà¸¡à¸­',
    'à¸„à¸§à¸²à¸¡à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§à¹à¸¥à¸°à¹„à¸¡à¹ˆà¸™à¹ˆà¸²à¸›à¸£à¸°à¸—à¸±à¸šà¹ƒà¸ˆ (Type 3)': 'à¸„à¸¸à¸“à¸à¸¥à¸±à¸§à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¸°à¹€à¸ªà¸µà¸¢à¸ à¸²à¸žà¸¥à¸±à¸à¸©à¸“à¹Œ à¸ˆà¸¶à¸‡à¸¡à¸¸à¹ˆà¸‡à¸¡à¸±à¹ˆà¸™à¸ªà¸¹à¸‡',
    'à¸à¸²à¸£à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸„à¸£à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆ (Type 4)': 'à¸„à¸¸à¸“à¸à¸¥à¸±à¸§à¸§à¹ˆà¸²à¸„à¸§à¸²à¸¡à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¹€à¸­à¸‡à¸ˆà¸°à¹„à¸¡à¹ˆà¸–à¸¹à¸à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆ',
    'à¸à¸²à¸£à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸£à¸·à¸­à¸–à¸¹à¸à¸„à¸§à¸šà¸„à¸¸à¸¡ (Type 5)': 'à¸„à¸¸à¸“à¸à¸¥à¸±à¸§à¸‚à¸²à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸£à¸·à¸­à¸–à¸¹à¸à¸ˆà¸³à¸à¸±à¸” à¸ˆà¸¶à¸‡à¹€à¸™à¹‰à¸™à¹€à¸ªà¸²à¸°à¸«à¸²à¸­à¸‡à¸„à¹Œà¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰',
    'à¸à¸²à¸£à¹„à¸¡à¹ˆà¸¡à¸µà¸«à¸¥à¸±à¸à¸¢à¸¶à¸” / à¹‚à¸”à¸”à¹€à¸”à¸µà¹ˆà¸¢à¸§ (Type 6)': 'à¸„à¸¸à¸“à¸à¸¥à¸±à¸§à¹„à¸£à¹‰à¸—à¸µà¹ˆà¸žà¸¶à¹ˆà¸‡ à¸ˆà¸¶à¸‡à¹€à¸œà¸·à¹ˆà¸­à¹à¸œà¸™à¹à¸¥à¸°à¸¡à¸­à¸‡à¸«à¸²à¸„à¸§à¸²à¸¡à¸¡à¸±à¹ˆà¸™à¸„à¸‡',
    'à¸„à¸§à¸²à¸¡à¹€à¸šà¸·à¹ˆà¸­ / à¸„à¸§à¸²à¸¡à¹€à¸ˆà¹‡à¸šà¸›à¸§à¸” (Type 7)': 'à¸„à¸¸à¸“à¸à¸¥à¸±à¸§à¸„à¸§à¸²à¸¡à¹€à¸ˆà¹‡à¸šà¸›à¸§à¸”à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¸™à¹ˆà¸²à¹€à¸šà¸·à¹ˆà¸­ à¸ˆà¸¶à¸‡à¹à¸ªà¸§à¸‡à¸«à¸²à¸„à¸§à¸²à¸¡à¸—à¹‰à¸²à¸—à¸²à¸¢',
    'à¸à¸²à¸£à¹„à¸£à¹‰à¸žà¸¥à¸±à¸‡ / à¸–à¸¹à¸à¸„à¸£à¸­à¸šà¸‡à¸³ (Type 8)': 'à¸„à¸¸à¸“à¸à¸¥à¸±à¸§à¸à¸²à¸£à¸–à¸¹à¸à¸„à¸£à¸­à¸šà¸‡à¸³ à¸ˆà¸¶à¸‡à¸¢à¸·à¸™à¸«à¸¢à¸±à¸”à¹€à¸žà¸·à¹ˆà¸­à¸žà¸¥à¸±à¸‡à¹à¸¥à¸°à¸­à¸´à¸ªà¸£à¸ à¸²à¸ž',
    'à¸„à¸§à¸²à¸¡à¸‚à¸±à¸”à¹à¸¢à¹‰à¸‡ / à¸„à¸§à¸²à¸¡à¸§à¸¸à¹ˆà¸™à¸§à¸²à¸¢ (Type 9)': 'à¸„à¸¸à¸“à¸à¸¥à¸±à¸§à¸„à¸§à¸²à¸¡à¸§à¸¸à¹ˆà¸™à¸§à¸²à¸¢ à¸ˆà¸¶à¸‡à¸žà¸¢à¸²à¸¢à¸²à¸¡à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸§à¸²à¸¡à¸ªà¸¡à¸”à¸¸à¸¥à¹à¸¥à¸°à¸ªà¸±à¸™à¸•à¸´'
}

# ---------- PROFILE BULLETS ---------- #
type_profile_map = {
    '1': [
        'à¸•à¸£à¸‡à¹„à¸›à¸•à¸£à¸‡à¸¡à¸² à¹„à¸¡à¹ˆà¸¢à¸­à¸¡à¸›à¸¥à¹ˆà¸­à¸¢à¸œà¹ˆà¸²à¸™à¸‡à¸²à¸™à¸šà¸à¸žà¸£à¹ˆà¸­à¸‡',
        'à¸•à¸£à¸§à¸ˆà¸‡à¸²à¸™à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ˆà¸™à¸„à¸™à¸£à¸­à¸šà¸‚à¹‰à¸²à¸‡à¸à¸”à¸”à¸±à¸™',
        'à¸•à¸±à¹‰à¸‡à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¸ªà¸¹à¸‡à¸¡à¸²à¸ à¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡à¸•à¹‰à¸­à¸‡à¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ',
        'à¸«à¸‡à¸¸à¸”à¸«à¸‡à¸´à¸”à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸«à¹‡à¸™à¸„à¸§à¸²à¸¡à¸œà¸´à¸”à¹à¸¡à¹‰à¹€à¸¥à¹‡à¸à¸™à¹‰à¸­à¸¢',
        'à¹€à¸ªà¸µà¸¢à¸‡à¸”à¸±à¸‡à¹€à¸•à¸·à¸­à¸™à¹€à¸§à¸¥à¸²à¹€à¸ˆà¸­à¸„à¸™à¸—à¸³à¸‡à¸²à¸™à¹„à¸¡à¹ˆà¸¥à¸°à¹€à¸­à¸µà¸¢à¸”'
    ],
    '2': [
        'à¹€à¸­à¸²à¹ƒà¸ˆà¹€à¸à¹ˆà¸‡ à¸”à¸¹à¹à¸¥à¸„à¸™à¸£à¸­à¸šà¸‚à¹‰à¸²à¸‡à¸ˆà¸™à¹€à¸«à¸¡à¸·à¸­à¸™à¹„à¸¡à¹ˆà¸¡à¸µà¸§à¸±à¸™à¸«à¸¢à¸¸à¸”',
        'à¸Šà¸­à¸šà¸Šà¹ˆà¸§à¸¢à¹€à¸«à¸¥à¸·à¸­à¹€à¸à¸´à¸™à¸‚à¸­à¸šà¹€à¸‚à¸• à¸šà¸²à¸‡à¸„à¸£à¸±à¹‰à¸‡à¸•à¸±à¸§à¹€à¸­à¸‡à¹€à¸«à¸™à¸·à¹ˆà¸­à¸¢',
        'à¸­à¸¢à¸²à¸à¹ƒà¸«à¹‰à¸—à¸¸à¸à¸„à¸™à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸”à¸µ à¹„à¸¡à¹ˆà¸Šà¸­à¸šà¸šà¸£à¸£à¸¢à¸²à¸à¸²à¸¨à¸•à¸¶à¸‡à¹€à¸„à¸£à¸µà¸¢à¸”',
        'à¸—à¸³à¸‡à¸²à¸™à¹€à¸›à¹‡à¸™à¸—à¸µà¸¡à¸”à¸µ à¹à¸•à¹ˆà¸–à¹‰à¸²à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸–à¸¹à¸à¹€à¸¡à¸´à¸™à¸ˆà¸°à¹€à¸„à¸£à¸µà¸¢à¸”',
        'à¸šà¸²à¸‡à¸—à¸µà¸¥à¸·à¸¡à¸–à¸²à¸¡à¸•à¸±à¸§à¹€à¸­à¸‡à¸§à¹ˆà¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸­à¸°à¹„à¸£'
    ],
    '3': [
        'à¸¡à¸¸à¹ˆà¸‡à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢à¸Šà¸±à¸”à¹€à¸ˆà¸™ à¸•à¹‰à¸­à¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¸•à¸²à¸¡à¹€à¸à¸“à¸‘à¹Œ',
        'à¸œà¸¥à¸±à¸à¸”à¸±à¸™à¸—à¸µà¸¡à¹ƒà¸«à¹‰à¸—à¸³à¸‡à¸²à¸™à¹€à¸£à¹‡à¸§à¹à¸¥à¸°à¸¡à¸µà¸›à¸£à¸°à¸ªà¸´à¸—à¸˜à¸´à¸ à¸²à¸ž',
        'à¹„à¸¡à¹ˆà¸Šà¸­à¸šà¸„à¸§à¸²à¸¡à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§ à¸ˆà¸°à¸›à¸£à¸±à¸šà¹à¸œà¸™à¸—à¸±à¸™à¸—à¸µà¸–à¹‰à¸²à¸œà¸¥à¹„à¸¡à¹ˆà¸­à¸­à¸à¸¡à¸²',
        'à¸•à¸±à¹‰à¸‡ KPI à¸—à¸¸à¸à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œà¸ˆà¸™à¸Šà¸±à¸”à¹€à¸ˆà¸™',
        'à¸à¸”à¸”à¸±à¸™à¸„à¸™à¸£à¸­à¸šà¸‚à¹‰à¸²à¸‡à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹€à¸«à¹‡à¸™à¸œà¸¥à¸‡à¸²à¸™'
    ],
    '4': [
        'à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸£à¸£à¸„à¹Œà¸‡à¸²à¸™à¸”à¹‰à¸§à¸¢à¸¡à¸¸à¸¡à¸¡à¸­à¸‡à¹„à¸¡à¹ˆà¸‹à¹‰à¸³à¹ƒà¸„à¸£',
        'à¸¡à¸µà¸­à¸²à¸£à¸¡à¸“à¹Œà¸¥à¸¶à¸à¸‹à¸¶à¹‰à¸‡ à¸£à¸¹à¹‰à¸ªà¸¶à¸à¸­à¸´à¸™à¸à¸±à¸šà¸‡à¸²à¸™à¸¡à¸²à¸',
        'à¸Šà¸­à¸šà¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹ƒà¸™à¸”à¸µà¹€à¸—à¸¥à¹€à¸Šà¸´à¸‡à¸¨à¸´à¸¥à¸›à¹Œ',
        'à¸–à¹‰à¸²à¸­à¸²à¸£à¸¡à¸“à¹Œà¸‚à¸¶à¹‰à¸™à¹† à¸¥à¸‡à¹† à¸ˆà¸°à¸«à¸¢à¸¸à¸”à¸—à¸³à¸‡à¸²à¸™à¸ªà¸±à¹‰à¸™à¹†',
        'à¸¡à¸±à¸à¹€à¸à¹‡à¸šà¸•à¸±à¸§à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸¢à¸­à¸¡à¸£à¸±à¸š'
    ],
    '5': [
        'à¹€à¸™à¸´à¸£à¹Œà¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ à¸–à¸²à¸¡à¹€à¸¢à¸­à¸°à¸à¹ˆà¸­à¸™à¸¥à¸‡à¸¡à¸·à¸­',
        'à¹€à¸•à¸£à¸µà¸¢à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸™à¹ˆà¸™à¸ˆà¸™à¸žà¸£à¹‰à¸­à¸¡à¸ˆà¸°à¹€à¸£à¸´à¹ˆà¸¡à¸‡à¸²à¸™',
        'à¸­à¸²à¸ˆà¹ƒà¸Šà¹‰à¹€à¸§à¸¥à¸²à¸™à¸²à¸™à¹€à¸žà¸£à¸²à¸°à¸à¸¥à¸±à¸§à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸žà¸­',
        'à¸¡à¸¸à¸¡à¸¡à¸­à¸‡à¸¥à¸¶à¸à¸‹à¸¶à¹‰à¸‡ à¹à¸•à¹ˆà¸„à¸™à¸­à¸·à¹ˆà¸™à¸­à¸²à¸ˆà¸£à¸¹à¹‰à¸ªà¸¶à¸à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸¢à¸²à¸',
        'à¸Šà¸­à¸šà¸«à¸²à¹€à¸«à¸•à¸¸à¸œà¸¥à¸à¹ˆà¸­à¸™à¸—à¸³à¸—à¸¸à¸à¸­à¸¢à¹ˆà¸²à¸‡'
    ],
    '6': [
        'à¸§à¸²à¸‡à¹à¸œà¸™à¸ªà¸³à¸£à¸­à¸‡à¸—à¸¸à¸à¸à¸£à¸“à¸µ à¹„à¸¡à¹ˆà¸Šà¸­à¸šà¹€à¸ªà¸µà¹ˆà¸¢à¸‡',
        'à¸„à¸´à¸”à¸–à¸¶à¸‡à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¸¡à¸±à¹ˆà¸™à¸„à¸‡à¸à¹ˆà¸­à¸™à¸¥à¸‡à¸¡à¸·à¸­',
        'à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¸Šà¹‰à¸²à¹€à¸žà¸£à¸²à¸°à¸•à¹‰à¸­à¸‡à¸¡à¸±à¹ˆà¸™à¹ƒà¸ˆà¸à¹ˆà¸­à¸™',
        'à¸«à¸²à¸ˆà¸¸à¸”à¸šà¸à¸žà¸£à¹ˆà¸­à¸‡à¸ˆà¸™à¸šà¸²à¸‡à¸„à¸£à¸±à¹‰à¸‡à¹€à¸ªà¸µà¸¢à¹€à¸§à¸¥à¸²',
        'à¸Šà¸­à¸šà¸–à¸²à¸¡à¸§à¹ˆà¸²à¸ˆà¸°à¸£à¸±à¸šà¸¡à¸·à¸­à¸¢à¸±à¸‡à¹„à¸‡à¸«à¸²à¸à¸œà¸´à¸”à¸žà¸¥à¸²à¸”'
    ],
    '7': [
        'à¸„à¸´à¸”à¹„à¸­à¹€à¸”à¸µà¸¢à¹ƒà¸«à¸¡à¹ˆà¸•à¸¥à¸­à¸” à¹„à¸¡à¹ˆà¸¡à¸µà¸«à¸¢à¸¸à¸”à¸„à¸´à¸”',
        'à¸à¸£à¸°à¸•à¸·à¸­à¸£à¸·à¸­à¸£à¹‰à¸™ à¸Šà¸§à¸™à¸—à¸µà¸¡à¸—à¸³à¸­à¸°à¹„à¸£à¸ªà¸™à¸¸à¸à¹† à¹„à¸”à¹‰à¹€à¸ªà¸¡à¸­',
        'à¹€à¸šà¸·à¹ˆà¸­à¸‡à¹ˆà¸²à¸¢ à¸–à¹‰à¸²à¸‡à¸²à¸™à¸‹à¹‰à¸³à¹† à¸ˆà¸°à¹€à¸£à¸´à¹ˆà¸¡à¸«à¸²à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œà¹ƒà¸«à¸¡à¹ˆ',
        'à¸ªà¸¡à¸²à¸˜à¸´à¸ªà¸±à¹‰à¸™ à¸šà¸²à¸‡à¸„à¸£à¸±à¹‰à¸‡à¸‚à¹‰à¸²à¸¡à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™',
        'à¹à¸•à¹ˆà¸¥à¸°à¸§à¸±à¸™à¹€à¸•à¹‡à¸¡à¹„à¸›à¸”à¹‰à¸§à¸¢à¸„à¸§à¸²à¸¡à¸—à¹‰à¸²à¸—à¸²à¸¢à¹ƒà¸«à¸¡à¹ˆà¹†'
    ],
    '8': [
        'à¹€à¸”à¹‡à¸”à¸‚à¸²à¸” à¸à¸¥à¹‰à¸²à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹à¸¥à¸°à¸ªà¸±à¹ˆà¸‡à¸à¸²à¸£',
        'à¹„à¸¡à¹ˆà¸à¸¥à¸±à¸§à¹€à¸œà¸Šà¸´à¸à¸«à¸™à¹‰à¸²à¸„à¸§à¸²à¸¡à¸‚à¸±à¸”à¹à¸¢à¹‰à¸‡',
        'à¸žà¸²à¸—à¸µà¸¡à¹€à¸”à¸´à¸™à¸«à¸™à¹‰à¸²à¹€à¸•à¹‡à¸¡à¸—à¸µà¹ˆ à¹„à¸¡à¹ˆà¸¡à¸µà¸–à¸­à¸¢',
        'à¸šà¸²à¸‡à¸„à¸£à¸±à¹‰à¸‡à¸™à¹‰à¸³à¹€à¸ªà¸µà¸¢à¸‡à¹à¸‚à¹‡à¸‡à¹€à¸à¸´à¸™à¹„à¸›',
        'à¸„à¸™à¸­à¹ˆà¸­à¸™à¹à¸­à¸¡à¸±à¸à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸à¸²à¸£à¸£à¹ˆà¸§à¸¡à¸‡à¸²à¸™'
    ],
    '9': [
        'à¹ƒà¸ˆà¹€à¸¢à¹‡à¸™à¸¡à¸²à¸ à¹„à¸¡à¹ˆà¸ªà¸£à¹‰à¸²à¸‡à¸„à¸§à¸²à¸¡à¸‚à¸±à¸”à¹à¸¢à¹‰à¸‡',
        'à¸›à¸£à¸°à¸ªà¸²à¸™à¸‡à¸²à¸™à¹ƒà¸«à¹‰à¸„à¸™à¸­à¸¢à¸¹à¹ˆà¸£à¹ˆà¸§à¸¡à¸à¸±à¸™à¹„à¸”à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¸ªà¸‡à¸š',
        'à¸šà¸²à¸‡à¸„à¸£à¸±à¹‰à¸‡à¸™à¸´à¹ˆà¸‡à¸ˆà¸™à¸„à¸™à¸­à¸·à¹ˆà¸™à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸ˆà¸°à¸›à¸£à¸¶à¸à¸©à¸²à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸‡à¸²à¸™',
        'à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸›à¸±à¸à¸«à¸² à¹à¸•à¹ˆà¸­à¸²à¸ˆà¸›à¸¥à¹ˆà¸­à¸¢à¹ƒà¸«à¹‰à¸„à¹‰à¸²à¸‡à¸„à¸²',
        'à¸šà¸²à¸‡à¸—à¸µà¸à¹‡à¸Šà¹‰à¸²à¹€à¸à¸´à¸™à¹„à¸›à¸ˆà¸™à¸žà¸¥à¸²à¸”à¹‚à¸­à¸à¸²à¸ª'
    ]
}

# ---------- SESSION STATE ---------- #
for key in ['main_submitted', 'sub_submitted']:
    if key not in st.session_state:
        st.session_state[key] = False
if 'responses' not in st.session_state:
    st.session_state.responses = []
if 'sub_answers' not in st.session_state:
    st.session_state.sub_answers = {}

# ---------- MAIN FORM ---------- #
st.markdown("### à¹‚à¸›à¸£à¸”à¹ƒà¸«à¹‰à¸„à¸°à¹à¸™à¸™à¹à¸•à¹ˆà¸¥à¸°à¸‚à¹‰à¸­ (1 = à¹„à¸¡à¹ˆà¸•à¸£à¸‡à¹€à¸¥à¸¢, 5 = à¸•à¸£à¸‡à¸¡à¸²à¸)")
with st.form('main_form'):
    temp = []
    for i, r in df_questions.iterrows():
        val = st.slider(f"à¸‚à¹‰à¸­ {r['Question Number']}: {r['Question (Thai)'].split('à¸ªà¸³à¸«à¸£à¸±à¸š')[0].strip()}",1,5,3,key=f"s{i}")
        temp.append({'Type':r['Enneagram Type'],'Category':r['Question Category'],'Score':val})
    if st.form_submit_button('à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ'):
        st.session_state.main_submitted=True
        st.session_state.responses=temp

# ---------- RESULTS ---------- #
if st.session_state.main_submitted:
    df_r = pd.DataFrame(st.session_state.responses)
    sum_r = df_r.groupby(['Type','Category']).mean(numeric_only=True).reset_index()
    piv = sum_r.pivot(index='Type',columns='Category',values='Score').fillna(0)
    core = piv.get('Core',pd.Series(dtype=float))
    so = core.sort_values(ascending=False)
    top, sec = so.index[0], so.index[1]
    ts, ss = so.iloc[0], so.iloc[1]
    num, lbl = top.replace('Type ','').split(':')[0], top.split(': ')[1]

    st.success(f"à¸„à¸¸à¸“à¸¡à¸µà¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¹€à¸›à¹‡à¸™ Type {num} â†’ {lbl}")
    # bullets
    st.markdown('**à¸¥à¸±à¸à¸©à¸“à¸°à¹€à¸”à¹ˆà¸™ (5 à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¹ƒà¸Šà¹ˆà¹€à¸¥à¸¢):**')
    for b in type_profile_map.get(num,[]): st.markdown(f"- {b}")

    # Wing Detection
    type_index = int(num)
    left = type_index-1 if type_index>1 else 9
    right = type_index+1 if type_index<9 else 1
    wing_candidates = [f"Type {left}", f"Type {right}"]
    wing_scores = so.loc[so.index.str.startswith(tuple(wing_candidates))]
    if not wing_scores.empty:
        wing = wing_scores.idxmax()
        wing_num = wing.split(':')[0].replace('Type ','')
        wing_lbl = wing.split(': ')[1]
        st.info(f"Wing à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹„à¸›à¹„à¸”à¹‰à¸¡à¸²à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”: **Type {wing_num}** ({wing_lbl})")

    # collaborators & caution
    coll = so.iloc[1:3].index
    caut = so.iloc[-2:].index
    st.markdown('#### ðŸ¤ à¸„à¸™à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸—à¸³à¸‡à¸²à¸™à¸”à¹‰à¸§à¸¢à¹à¸¥à¹‰à¸§à¹€à¸§à¸´à¸£à¹Œà¸„')
    for t in coll: n,l=t.split(': '); st.markdown(f"- **{n}** ({l})")
    st.markdown('#### âš ï¸ à¸„à¸™à¸—à¸µà¹ˆà¸„à¸§à¸£à¸£à¸°à¸¡à¸±à¸”à¸£à¸°à¸§à¸±à¸‡à¹ƒà¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸”à¹‰à¸§à¸¢')
    for t in caut: n,l=t.split(': '); st.markdown(f"- **{n}** ({l})")

    # radar chart
    labels=[x.replace('Type ','T') for x in core.index]
    vals=list(core); ang=np.linspace(0,2*np.pi,len(vals),endpoint=False).tolist()
    vals+=vals[:1]; ang+=ang[:1]
    fig,ax=plt.subplots(subplot_kw={'polar':True})
    ax.plot(ang,vals,linewidth=2,linestyle='solid'); ax.fill(ang,vals,alpha=0.25)
    ax.set_thetagrids(np.degrees(ang[:-1]),labels)
    st.pyplot(fig)

    # sub-questions if tie
    if abs(ts-ss)<0.2:
        st.warning('à¸„à¸°à¹à¸™à¸™ Core à¹ƒà¸à¸¥à¹‰à¸à¸±à¸™! à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹€à¸ªà¸£à¸´à¸¡à¹€à¸žà¸·à¹ˆà¸­à¹à¸¢à¸à¹ƒà¸«à¹‰à¸Šà¸±à¸”')
        with st.expander('ðŸ§  à¸„à¸³à¸–à¸²à¸¡à¹€à¸ªà¸£à¸´à¸¡à¹€à¸žà¸·à¹ˆà¸­à¹à¸¢à¸ Core'):
            with st.form('sub'): # subform
                for q in universal_sub_questions:
                    st.session_state.sub_answers[q['question']] = st.radio(q['question'],q['choices'],key=q['question'])
                if st.form_submit_button('ðŸ” à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ'): st.session_state.sub_submitted=True
            if st.session_state.sub_submitted:
                a1=st.session_state.sub_answers[universal_sub_questions[0]['question']]
                a2=st.session_state.sub_answers[universal_sub_questions[1]['question']]
                st.markdown(f"- à¸„à¸¸à¸“à¹€à¸¥à¸·à¸­à¸ '{a1}' â†’ {sub_analysis_map.get(a1,'')}")
                st.markdown(f"- à¸„à¸¸à¸“à¸à¸¥à¸±à¸§ '{a2}' â†’ {sub_analysis_map.get(a2,'')}")
